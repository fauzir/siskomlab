"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskView!="undefined"){return}BX.Tasks.Component.TaskView=function(t){this.parameters=t||{};this.taskId=this.parameters.taskId;this.stageId=parseInt(this.parameters.stageId);this.stages=this.parameters.stages||{};this.layout={favorite:BX("task-detail-favorite"),switcher:BX("task-switcher"),switcherTabs:[],elapsedTime:BX("task-switcher-elapsed-time"),createButton:BX("task-detail-create-button"),importantButton:BX("task-detail-important-button"),stagesWrap:BX("tasksStagesWrap"),stages:BX("tasksStages")};this.messages=this.parameters.messages||{};for(var e in this.messages){BX.message[e]=this.messages[e]}this.paths=this.parameters.paths||{};this.createButtonMenu=[];this.query=new BX.Tasks.Util.Query;this.query.bindEvent("executed",BX.proxy(this.onQueryExecuted,this));BX.addCustomEvent(window,"tasksTaskEvent",this.onTaskEvent.bind(this));BX.addCustomEvent(window,"onChangeProjectLink",BX.delegate(this.onChangeProjectLink,this));this.initFavorite();this.initCreateButton();this.initSwitcher();this.initViewer();this.initAjaxErrorHandler();this.initImportantButton();this.initStages();this.fireTaskEvent();this.temporalCommentFix()};BX.Tasks.Component.TaskView.prototype.temporalCommentFix=function(){BX.addCustomEvent(window,"OnUCFormResponse",function(t,e,s){if(BX.type.isNotEmptyString(t)&&t.indexOf("TASK_")===0&&BX.proxy_context&&BX.proxy_context.jsonFailure===true){if(s&&s["handler"]&&s.handler["oEditor"]&&s.handler.oEditor["DenyBeforeUnloadHandler"]){s.handler.oEditor.DenyBeforeUnloadHandler()}BX.reload()}})};BX.Tasks.Component.TaskView.prototype.fireTaskEvent=function(){if(this.parameters.eventTaskUgly!=null){BX.Tasks.Util.fireGlobalTaskEvent(this.parameters.componentData.EVENT_TYPE,{ID:this.parameters.eventTaskUgly.id},{STAY_AT_PAGE:true},this.parameters.eventTaskUgly)}};BX.Tasks.Component.TaskView.prototype.initImportantButton=function(){if(this.parameters.can.TASK.ACTION.EDIT){BX.bind(this.layout.importantButton,"click",BX.Tasks.passCtx(this.onImportantButtonClick,this))}};BX.Tasks.Component.TaskView.prototype.initStages=function(){if(this.layout.stages&&this.stages){var t=this.parameters.can.TASK.ACTION.SORT;var e=this.stages.length>0;BX.cleanNode(this.layout.stages);for(var s=0,a=this.stages.length;s<a;s++){this.layout.stages.appendChild(BX.create("div",{props:{className:"task-section-status-step"},children:[BX.create("div",{props:{className:"task-section-status-step-item"},children:[this.stages[s].TEXT_LAYOUT=BX.create("div",{attrs:{"data-stageId":this.stages[s].ID},props:{className:"task-section-status-step-item-text"},text:this.stages[s].TITLE,events:t?{click:BX.delegate(this.setStageHadnler,this)}:null,style:!t?{cursor:"default"}:null})]})]}))}if(e){BX.show(this.layout.stagesWrap);if(this.stageId>0){this.setStage(this.stageId)}else{this.setStage(this.stages[0].ID)}}else{BX.hide(this.layout.stagesWrap)}}};BX.Tasks.Component.TaskView.prototype.onChangeProjectLink=function(t,e){t=parseInt(t);this.stageId=0;if(t===0){this.stages=[];this.initStages()}else{var s={entityId:t,entityType:"G"};this.query.run("task.stages.canmovetask",s).then(function(t){if(t.isSuccess()){this.parameters.can.TASK.ACTION.SORT=t.data===true}}.bind(this));var s={entityId:t,numeric:true};this.query.run("task.stages.get",s).then(function(t){if(t.isSuccess()){this.stages=t.data;this.initStages()}}.bind(this));this.query.execute()}};BX.Tasks.Component.TaskView.prototype.getStageData=function(t){t=parseInt(t);if(this.stages){for(var e in this.stages){if(parseInt(this.stages[e].ID)===t){return this.stages[e]}}}return null};BX.Tasks.Component.TaskView.prototype.setStageHadnler=function(){var t=BX.data(BX.proxy_context,"stageId");this.setStage(t);this.saveStage(t)};BX.Tasks.Component.TaskView.prototype.saveStage=function(t){t=parseInt(t);if(t===this.stageId){return}this.stageId=t;var e={id:this.taskId,stageId:t};this.query.run("task.stages.movetask",e).then(function(t){if(t.isSuccess()){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE_STAGE",{ID:e.id,STAGE_ID:e.stageId},{STAY_AT_PAGE:true},{id:e.id})}}.bind(this));this.query.execute()};BX.Tasks.Component.TaskView.prototype.setStage=function(t){var e=this.getStageData(t);t=parseInt(t);if(this.stages&&e){var s="#"+e["COLOR"];var a=true;var i;for(var n=0,o=this.stages.length;n<o;n++){i=this.stages[n].TEXT_LAYOUT;if(a){i.style.color=this.calculateTextColor(s);i.style.backgroundColor=s;i.style.borderBottomColor=s}else{i.style.backgroundColor="";i.style.borderBottomColor="#"+this.stages[n].COLOR}if(parseInt(this.stages[n].ID)===t){a=false}}}};BX.Tasks.Component.TaskView.prototype.calculateTextColor=function(t){var e=["00c4fb","47d1e2","75d900","ffab00","ff5752","468ee5","1eae43"];var s,a,i;if(BX.util.in_array(t.toLowerCase(),e)){return"#fff"}else{var n=t.split("");if(n.length==3){n=[n[0],n[0],n[1],n[1],n[2],n[2]]}n="0x"+n.join("");s=n>>16&255;a=n>>8&255;i=n&255}var o=.21*s+.72*a+.07*i;return o<145?"#fff":"#333"};BX.Tasks.Component.TaskView.prototype.initCreateButton=function(){BX.bind(this.layout.createButton,"click",this.onCreateButtonClick.bind(this));var t=this.paths;var e=this;this.createButtonMenu=[{text:this.messages.addTask,className:"menu-popup-item menu-popup-no-icon",href:this.paths.newTask},{text:this.messages.addTaskByTemplate,className:"menu-popup-item menu-popup-no-icon menu-popup-item-submenu",events:{onSubMenuShow:function(){if(this.subMenuLoaded){return}var s=new BX.Tasks.Util.Query({autoExec:true});var a=this.getSubMenu();a.removeMenuItem("loading");s.add("task.template.find",{parameters:{select:["ID","TITLE"]}},{},BX.delegate(function(s,a){this.subMenuLoaded=true;if(!s.checkHasErrors()){var i=t.newTask+(t.newTask.indexOf("?")!==-1?"&":"?")+"TEMPLATE=";var n=[];if(a.RESULT.DATA.length>0){BX.Tasks.each(a.RESULT.DATA,function(t,e){n.push({text:BX.util.htmlspecialchars(t.TITLE),href:i+t.ID})}.bind(this))}else{n.push({text:e.messages.tasksAjaxEmpty})}this.addSubMenu(n);this.showSubMenu()}else{this.addSubMenu([{text:e.messages.tasksAjaxErrorLoad}]);this.showSubMenu()}},this))}},items:[{id:"loading",text:"TASKS_AJAX_LOAD_TEMPLATES"}]},{delimiter:true},{text:this.messages.addSubTask,className:"menu-popup-item menu-popup-no-icon",href:this.paths.newSubTask},{delimiter:true},{text:this.messages.listTaskTemplates,className:"menu-popup-item menu-popup-no-icon",href:this.paths.taskTemplates}]};BX.Tasks.Component.TaskView.prototype.onImportantButtonClick=function(t){var e=BX.data(t,"priority");var s=e==2?1:2;this.query.run("task.update",{id:this.parameters.taskId,data:{PRIORITY:s}}).then(function(e){if(e.isSuccess()){BX.data(t,"priority",s);BX.toggleClass(t,"no")}}.bind(this));this.query.execute()};BX.Tasks.Component.TaskView.prototype.onCreateButtonClick=function(){BX.PopupMenu.show("task-detail-create-button",this.layout.createButton,this.createButtonMenu,{angle:{position:"top",offset:40}})};BX.Tasks.Component.TaskView.prototype.onTaskEvent=function(t,e){e=e||{};var s=e.task||{};if(t=="UPDATE"&&s.ID==this.parameters.taskId){if(BX.type.isNotEmptyString(s.REAL_STATUS)){this.setStatus(s.REAL_STATUS)}}};BX.Tasks.Component.TaskView.prototype.setStatus=function(t){var e=BX("task-detail-status-below-name");if(e){var s=BX.message("TASKS_STATUS_"+t);e.innerHTML=s.substr(0,1).toLowerCase()+s.substr(1)}};BX.Tasks.Component.TaskView.prototype.initFavorite=function(){BX.bind(this.layout.favorite,"click",BX.proxy(this.onFavoriteClick,this))};BX.Tasks.Component.TaskView.prototype.onFavoriteClick=function(){var t=BX.hasClass(this.layout.favorite,"task-detail-favorite-active")?"task.favorite.delete":"task.favorite.add";this.query.deleteAll();this.query.add(t,{taskId:this.taskId},{code:t});this.query.execute();BX.toggleClass(this.layout.favorite,"task-detail-favorite-active")};BX.Tasks.Component.TaskView.prototype.initSwitcher=function(){if(!this.layout.switcher){return}var t=this.layout.switcher.getElementsByClassName("task-switcher");var e=this.layout.switcher.parentNode.getElementsByClassName("task-switcher-block");for(var s=0;s<t.length;s++){var a=t[s];var i=e[s];BX.bind(a,"click",BX.proxy(this.onSwitch,this));this.layout.switcherTabs.push({title:a,block:i})}BX.addCustomEvent("TaskElapsedTimeUpdated",BX.proxy(function(t,e,s,a){this.layout.elapsedTime.innerText=BX.Tasks.Util.formatTimeAmount(a.time)},this))};BX.Tasks.Component.TaskView.prototype.onSwitch=function(){var t=BX.proxy_context;if(BX.hasClass(t,"task-switcher-selected")){return false}for(var e=0;e<this.layout.switcherTabs.length;e++){var s=this.layout.switcherTabs[e].title;var a=this.layout.switcherTabs[e].block;if(s===t){BX.addClass(s,"task-switcher-selected");BX.addClass(a,"task-switcher-block-selected")}else{BX.removeClass(s,"task-switcher-selected");BX.removeClass(a,"task-switcher-block-selected")}}return false};BX.Tasks.Component.TaskView.prototype.onQueryExecuted=function(t){};BX.Tasks.Component.TaskView.prototype.initViewer=function(){var t=["task-detail-description","task-detail-files","task-comments-block","task-files-block"];for(var e=0;e<t.length;e++){var s=BX(t[e]);if(s){top.BX.viewElementBind(s,{},function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))})}}};BX.Tasks.Component.TaskView.prototype.initAjaxErrorHandler=function(){BX.addCustomEvent("TaskAjaxError",function(t){BX.Tasks.alert(t).then(function(){BX.reload()})})}}).call(this);
//# sourceMappingURL=logic.map.js